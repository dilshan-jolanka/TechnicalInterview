<!DOCTYPE html>
<html>
<head>
    <title>Simple Timer</title>
    <!-- Import React -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Import Babel for JSX -->
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: transparent;
        }
        
        #timer-root {
            padding: 10px;
        }
        
        .timer-container {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 10px;
            background-color: white;
        }
        
        .timer-header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            background-color: #f7f7f7;
            border-bottom: 1px solid #eee;
        }
        
        .timer-display {
            font-size: 28px;
            font-weight: bold;
            transition: color 0.5s;
        }
        
        .timer-progress {
            height: 6px;
            background-color: #f0f2f6;
            width: 100%;
        }
        
        .timer-progress-bar {
            height: 100%;
            width: 0%;
            background-color: #4CAF50;
            transition: width 1s, background-color 1s;
        }
        
        .timer-label {
            font-size: 14px;
            color: #666;
            text-align: center;
            padding: 8px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div id="timer-root"></div>
    
    <script type="text/babel">
        // Simple Timer Component
        const SimpleTimer = () => {
            // State hooks
            const [timeDisplay, setTimeDisplay] = React.useState('--:--');
            const [progress, setProgress] = React.useState(0);
            const [color, setColor] = React.useState('#4CAF50');
            
            // Timer data
            const [timerData, setTimerData] = React.useState({
                startTime: null,
                timeLimit: 3600 // Default: 60 minutes in seconds
            });
            
            // Timer effect
            React.useEffect(() => {
                // Timer update function
                const updateTimer = () => {
                    if (!timerData.startTime) {
                        // Try to get from URL if not set
                        const startTimeParam = getUrlParameter('startTime');
                        const timeLimitParam = getUrlParameter('timeLimit');
                        
                        if (startTimeParam && timeLimitParam) {
                            setTimerData({
                                startTime: startTimeParam,
                                timeLimit: parseInt(timeLimitParam)
                            });
                        }
                        return;
                    }
                    
                    const startTime = new Date(timerData.startTime);
                    const currentTime = new Date();
                    const elapsedSeconds = (currentTime - startTime) / 1000;
                    const remainingSeconds = Math.max(0, timerData.timeLimit - elapsedSeconds);
                    
                    // Calculate minutes and seconds
                    const minutes = Math.floor(remainingSeconds / 60);
                    const seconds = Math.floor(remainingSeconds % 60);
                    
                    // Format display string
                    const displayText = 
                        (minutes < 10 ? "0" : "") + minutes + ":" + 
                        (seconds < 10 ? "0" : "") + seconds;
                    
                    // Update states
                    setTimeDisplay(displayText);
                    setProgress((elapsedSeconds / timerData.timeLimit) * 100);
                    
                    // Change color when time is running out
                    if (remainingSeconds < 60) { // Less than 1 minute
                        setColor('#ff0000');
                    } else if (remainingSeconds < 300) { // Less than 5 minutes
                        setColor('#ff4500');
                    } else if (remainingSeconds < 600) { // Less than 10 minutes
                        setColor('#ff9800');
                    } else {
                        setColor('#4CAF50');
                    }
                    
                    // Check if time expired
                    if (remainingSeconds <= 0) {
                        // Notify parent window
                        if (window.parent) {
                            window.parent.postMessage('timer_expired', '*');
                        }
                    }
                };
                
                // Set up timer interval - start immediately and update every second
                updateTimer(); // Initial call
                const timerId = setInterval(updateTimer, 1000);
                
                // Clean up interval
                return () => clearInterval(timerId);
            }, [timerData]);
            
            // Initialize with URL params automatically when component mounts
            React.useEffect(() => {
                const startTimeParam = getUrlParameter('startTime');
                const timeLimitParam = getUrlParameter('timeLimit');
                
                if (startTimeParam && timeLimitParam) {
                    setTimerData({
                        startTime: startTimeParam,
                        timeLimit: parseInt(timeLimitParam)
                    });
                }
            }, []);
            
            // Also try to initialize immediately on component mount
            React.useEffect(() => {
                const initTimer = () => {
                    const startTimeParam = getUrlParameter('startTime');
                    const timeLimitParam = getUrlParameter('timeLimit');
                    
                    if (startTimeParam && timeLimitParam) {
                        console.log('Initializing timer with:', startTimeParam, timeLimitParam);
                        setTimerData({
                            startTime: startTimeParam,
                            timeLimit: parseInt(timeLimitParam)
                        });
                    }
                };
                
                // Try immediately
                initTimer();
                
                // Also try after a short delay in case URL params aren't ready
                setTimeout(initTimer, 100);
            }, []);
            
            return (
                <div className="timer-container">
                    <div className="timer-label">
                        Time Remaining
                    </div>
                    <div className="timer-header">
                        <div className="timer-display" style={{ color: color }}>
                            {timeDisplay}
                        </div>
                    </div>
                    <div className="timer-progress">
                        <div 
                            className="timer-progress-bar" 
                            style={{ 
                                width: `${progress}%`,
                                backgroundColor: color
                            }}
                        />
                    </div>
                    {/* Debug info - remove in production */}
                    <div style={{ fontSize: '10px', color: '#666', padding: '5px' }}>
                        Start: {timerData.startTime ? new Date(timerData.startTime).toLocaleTimeString() : 'Not set'}<br/>
                        Limit: {timerData.timeLimit}s
                    </div>
                </div>
            );
        };
        
        // Render the component
        ReactDOM.render(
            <SimpleTimer />,
            document.getElementById('timer-root')
        );
        
        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
    </script>
</body>
</html>
